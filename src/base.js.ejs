class Variable {
    constructor(name, value) {
        this.name = name;
        this.value = value;
    }
}

class VariableFrame {
    constructor(parent) {
        this.parent = parent;
        this.vars = {};
    }

    get(name) {
        if (this.vars[name]) {
            return this.vars[name];
        } else if (this.parent) {
            return this.parent.get(name);
        }
    }

    set(name, value) {
        this.vars[name] = new Variable(name, value);
    }
}

class Stage {
    constructor(name, variables, customBlocks) {
        this.name = name;
        this.variables = new VariableFrame(variables);
        this.customBlocks = new VariableFrame(project.customBlocks);
        this.isSprite = false;
        this.variables.set('__SELF', this);
    }

    onFlagPressed() {
    }

    getTimerStart() {
        return project.timerStart;
    }

    resetTimer() {
        project.timerStart = Date.now();
    }

    getTempo() {
        return project.tempo;
    }

    setTempo(bpm) {
        return project.tempo = Math.max(20, (+bpm || 0));
    }
}

class Sprite extends Stage {
    constructor(name, variables, customBlocks) {
        super(name, variables, customBlocks);
        this.isClone = false;
        this.isSprite = true;
        this.xPosition = 0;
        this.yPosition = 0;
        this.direction = 90;
        this.costume = 0;
        this.size = 100;
    }
}

__ENV = __ENV || this;
var project = {
    variables: new VariableFrame(),
    customBlocks: new VariableFrame(),
    timerStart: null,
    tempo: <%= tempo %>,
    sprites: []
};
<% Object.keys(variables).forEach(function(variable) { %>
project.variables.set('<%= variable %>', JSON.parse('<%= JSON.stringify(variables[variable]) %>'));<% }) %>
<% customBlocks.forEach(function(def) { %>
project.customBlocks.set('<%= def.name %>', <%= def.code %>);
<% }) %>

project.stage = new Stage('Stage', project.variables, project.customBlocks);  // FIXME: use the stage name

// for each sprite...
var sprite;
<% sprites.forEach(function(rawSprite) { %>
sprite = new Sprite('<%= rawSprite.name %>', project.variables, project.customBlocks);
sprite.xPosition = <%= rawSprite.position.x %>;
sprite.yPosition = <%= rawSprite.position.y %>;
sprite.direction = <%= rawSprite.direction %>;
sprite.size = <%= rawSprite.size %>;
sprite.costumeIdx = <%= rawSprite.costumeIdx %>;
// TODO: Define the custom blocks
<% Object.keys(rawSprite.variables).forEach(function(variable) { %>
sprite.variables.set('<%= variable %>', JSON.parse('<%= JSON.stringify(rawSprite.variables[variable]) %>'));<% }) %>

sprite.onFlagPressed = function() {
    var self = this;
<%
rawSprite.scripts.receiveGo
    .forEach(function(code) {
%>
    <%= code %>

<%
});
%>
};

sprite.onKeyPressed = function(key) {
    var self = this;
    if (key === 'l') {
        // Add code for the given key...
        // TODO
    }
};

sprite.onUserEventReceived = function(event) {
    var self = this;

    if (event === 'fire!') {
        // Add code for the given event...
        // TODO
    }
};

sprite.onEventReceived = function(event) {
    var self = this;

    if (event === 'clicked') {
        // Add code for the given event...
        // TODO
    }
};

sprite.checkConditions = function() {
    var self = this;

    // TODO: add arbitrary hat block code here
};

project.sprites.push(sprite);
<% }) %>
project.timerStart = Date.now();
project.sprites.forEach(sprite => sprite.onFlagPressed());
project.stage.onFlagPressed();
