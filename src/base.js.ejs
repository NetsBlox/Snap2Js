class Variable {
    constructor(name, value) {
        this.name = name;
        this.value = value;
    }
}

class VariableFrame {
    constructor(parent) {
        this.parent = parent;
        this.vars = {};
    }

    get(name) {
        if (this.vars[name]) {
            return this.vars[name];
        } else if (this.parent) {
            return this.parent.get(name);
        }
    }

    set(name, value) {
        this.vars[name] = new Variable(name, value);
    }
}

class Stage {
    constructor(name, variables) {
        this.name = name;
        this.variables = new VariableFrame(variables);
        this.isSprite = false;
    }

    onFlagPressed() {
    }
}

class Sprite extends Stage {
    constructor(name, variables) {
        super(name, variables);
        this.isClone = false;
        this.isSprite = true;
    }
}

__ENV = __ENV || this;
var project = {
    variables: new VariableFrame(),
    sprites: []
};
<% Object.keys(variables).forEach(function(variable) { %>
project.variables.set('<%= variable %>', JSON.parse('<%= JSON.stringify(variables[variable]) %>'));<% }) %>

project.stage = new Stage(project.variables);

// for each sprite...
var sprite;
<% sprites.forEach(function(rawSprite) { %>
sprite = new Sprite('<%= rawSprite.name %>', project.variables);
<% Object.keys(rawSprite.variables).forEach(function(variable) { %>
sprite.variables.set('<%= variable %>', JSON.parse('<%= JSON.stringify(rawSprite.variables[variable]) %>'));<% }) %>

sprite.onFlagPressed = function() {
    var self = this;
<%
rawSprite.scripts.receiveGo
    .forEach(function(code) {
%>
    <%= code %>
<%
});
%>
};

sprite.onKeyPressed = function(key) {
    var self = this;
    if (key === 'l') {
        // Add code for the given key...
        // TODO
    }
};

sprite.onUserEventReceived = function(event) {
    var self = this;

    if (event === 'fire!') {
        // Add code for the given event...
        // TODO
    }
};

sprite.onEventReceived = function(event) {
    var self = this;

    if (event === 'clicked') {
        // Add code for the given event...
        // TODO
    }
};

sprite.checkConditions = function() {
    var self = this;

    // TODO: add arbitrary hat block code here
};

project.sprites.push(sprite);
<% }) %>
project.sprites.forEach(sprite => sprite.onFlagPressed());
project.stage.onFlagPressed();
